<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NanoBanana Pro — Ultra Realism Batch Studio</title>

  <style>
    :root{
      --bg:#080808;
      --panel:#141414;
      --input:#1f1f1f;
      --border:#2e2e2e;
      --accent:#ccff00;

      --text:#ffffff;
      --dim:#a8a8a8;
      --placeholder:#909090;
      --bad:#ff4d4d;

      /* grid controls */
      --cols: 3;
      --thumbH: 240px;

      /* dock */
      --dockH: 240px;
    }

    *{box-sizing:border-box;}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,sans-serif;
      margin:0;
      padding:18px;
      padding-bottom: calc(var(--dockH) + 24px);
    }

    .wrap{max-width:1220px; margin:0 auto;}
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
    }

    /* ---------- TOP AREA ---------- */
    .upload{
      height:200px;
      border:2px dashed var(--border);
      border-radius:16px;
      cursor:pointer;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:rgba(255,255,255,.02);
      transition:.2s;
      margin-bottom:12px;
    }
    .upload:hover{border-color:var(--accent); background:rgba(204,255,0,.05);}
    .upload p{color:var(--dim); margin:0; font-size:14px;}
    #fileInput{display:none;}
    #preview{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; display:none;}

    .out{margin-top:12px;}
    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .progress{
      flex:1;
      min-width:260px;
      height:10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#101010;
      overflow:hidden;
    }
    .progress > div{height:100%; width:0%; background:var(--accent);}
    .stat{
      color:var(--dim);
      font-size:13px;
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(var(--cols), minmax(0, 1fr));
      gap:12px;
    }
    @media(max-width:950px){ :root{ --cols: 2; } }
    @media(max-width:560px){ :root{ --cols: 1; } }

    .card{
      background:#0f0f0f;
      border:1px solid #1e1e1e;
      border-radius:14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .thumb{
      height:var(--thumbH);
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#9a9a9a;
      font-size:12px;
      padding:10px;
      text-align:center;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .meta{padding:12px;}
    .tag{
      color:#a0a0a0;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    pre{
      margin:8px 0 0 0;
      white-space:pre-wrap;
      word-break:break-word;
      color:#d6d6d6;
      font-size:12.5px;
      line-height:1.35;
      font-family:ui-monospace,Consolas,monospace;
      max-height:160px;
      overflow:auto;
      padding-right:6px;
    }
    .mini{
      display:flex;
      gap:10px;
      padding:12px;
      padding-top:0;
    }
    .mbtn{
      flex:1;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#000;
      color:#eaeaea;
      cursor:pointer;
      font-weight:950;
      font-size:12px;
    }
    .mbtn:hover{border-color:var(--accent); color:#fff;}
    .mbtn:disabled{opacity:.4; cursor:not-allowed;}

    /* ---------- DOCK (BOTTOM FIXED) ---------- */
    .dock{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:14px 18px;
      background: rgba(16,16,16,.80);
      border-top: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .dock .wrap{max-width:1220px; margin:0 auto;}
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .group{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .label{
      font-size:12px;
      font-weight:950;
      color:var(--dim);
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .btns{
      display:flex;
      background:#000;
      border:1px solid var(--border);
      border-radius:10px;
      padding:4px;
    }
    .tbtn{
      background:transparent;
      border:0;
      color:#c8c8c8;
      padding:8px 14px;
      font-weight:950;
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
      transition:.12s;
    }
    .tbtn:hover{color:#fff;}
    .tbtn.active{background:var(--accent); color:#000;}

    .field{
      display:flex;
      align-items:center;
      gap:10px;
      background:#000;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
    }
    .field input,.field select{
      background:transparent;
      border:0;
      outline:0;
      color:#fff;
      font-size:14px;
      min-width:120px;
    }
    .field small{color:var(--dim); font-size:12px; font-weight:900;}

    .in{
      flex:1;
      min-width:260px;
      display:flex;
      align-items:center;
      background:var(--input);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      padding:0 12px;
    }
    .in:focus-within{border-color: rgba(204,255,0,.35);}
    .in input{
      width:100%;
      background:transparent;
      border:0;
      outline:0;
      color:#fff;
      padding:14px 0;
      font-size:14px;
    }
    .in input::placeholder{color:var(--placeholder);}

    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .abtn{
      height:46px;
      padding:0 18px;
      border-radius:12px;
      border:0;
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      background:#2d2d2d;
      color:#d6d6d6;
      transition:.12s;
    }
    .abtn:hover{background:var(--accent); color:#000;}
    .abtn.alt{background:#000; border:1px solid var(--border); color:#f0f0f0;}
    .abtn.alt:hover{border-color:var(--accent); color:#fff;}
    .abtn.danger{
      background:transparent;
      border:1px solid var(--bad);
      color:var(--bad);
      display:none;
    }
    .abtn.danger:hover{background:rgba(255,77,77,.10);}

    .slider{
      display:flex;
      align-items:center;
      gap:10px;
      background:#000;
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 12px;
    }
    input[type=range]{
      -webkit-appearance:none;
      width:140px;
      height:4px;
      background:#333;
      border-radius:2px;
      outline:none;
    }
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:16px; height:16px;
      border-radius:50%;
      background:var(--accent);
      cursor:pointer;
      box-shadow:0 0 10px rgba(204,255,0,.5);
    }
    .mono{
      font-family:ui-monospace,Consolas,monospace;
      font-weight:950;
      color:var(--accent);
      width:42px;
      text-align:right;
    }

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.68); display:none; align-items:center; justify-content:center; padding:18px;}
    .box{width:100%; max-width:620px; background:#0f0f0f; border:1px solid #222; border-radius:18px; padding:16px; box-shadow:0 25px 80px rgba(0,0,0,.6);}
    .box h3{margin:0 0 8px 0; font-size:16px;}
    .box p{margin:0 0 12px 0; color:#a0a0a0; font-size:13px; line-height:1.35;}
    .box .row2{display:flex; gap:10px; flex-wrap:wrap;}
    .box input{flex:1; min-width:260px; background:#000; border:1px solid #333; border-radius:12px; padding:12px 14px; color:#fff; outline:none; font-family:ui-monospace,Consolas,monospace;}
    .save{height:44px; padding:0 16px; border-radius:12px; border:0; background:var(--accent); color:#000; font-weight:950; cursor:pointer;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="upload panel" id="dropZone">
      <p id="uploadText">Нажми или перетащи сюда фото (Reference optional)</p>
      <img id="preview" alt="preview"/>
      <input type="file" id="fileInput" accept="image/*"/>
    </div>

    <div class="panel out" id="output">
      <div class="topbar">
        <div class="progress"><div id="bar"></div></div>
        <div class="stat" id="stat">Idle</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Dock bottom -->
  <div class="dock">
    <div class="wrap">
      <div class="row">
        <div class="group">
          <span class="label">Model</span>
          <div class="btns" id="modelGroup">
            <button class="tbtn active" data-model="gemini-3-pro-image-preview">Pro</button>
            <button class="tbtn" data-model="gemini-2.5-flash-image">Flash</button>
          </div>
        </div>

        <div class="group">
          <span class="label">Ratio</span>
          <div class="btns" id="ratioGroup">
            <button class="tbtn" data-ratio="1:1">1:1</button>
            <button class="tbtn" data-ratio="3:4">3:4</button>
            <button class="tbtn" data-ratio="4:3">4:3</button>
            <button class="tbtn active" data-ratio="16:9">16:9</button>
            <button class="tbtn" data-ratio="9:16">9:16</button>
          </div>
        </div>

        <div class="group">
          <span class="label">Quality</span>
          <div class="btns" id="sizeGroup">
            <button class="tbtn active" data-size="1K">1K</button>
            <button class="tbtn" data-size="2K">2K</button>
            <button class="tbtn" data-size="4K">4K</button>
          </div>
        </div>

        <div class="group">
          <span class="label">Realism</span>
          <div class="btns" id="realismGroup">
            <button class="tbtn active" data-realism="on">Ultra ON</button>
            <button class="tbtn" data-realism="off">OFF</button>
          </div>
        </div>

        <div class="group">
          <span class="label">Count</span>
          <div class="slider">
            <span class="mono" id="countVal">50</span>
            <input type="range" id="countRange" min="1" max="200" value="50"/>
          </div>
        </div>

        <div class="group">
          <span class="label">Conc.</span>
          <div class="slider">
            <span class="mono" id="concVal">4</span>
            <input type="range" id="concRange" min="1" max="12" value="4"/>
          </div>
        </div>

        <div class="group">
          <span class="label">Cols</span>
          <div class="slider">
            <span class="mono" id="colsVal">3</span>
            <input type="range" id="colsRange" min="1" max="6" value="3"/>
          </div>
        </div>

        <div class="group">
          <span class="label">Tile</span>
          <div class="slider">
            <span class="mono" id="tileVal">240</span>
            <input type="range" id="tileRange" min="140" max="440" value="240"/>
          </div>
        </div>

        <div class="group">
          <span class="label">Key</span>
          <button class="abtn alt" id="keyBtn">Set API key</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="in"><input id="basePrompt" placeholder="Base prompt (например: luxury street portrait, wet asphalt, candid)"/></div>
        <div class="in"><input id="avoid" placeholder="Avoid (через запятую): watermark, blurry, extra fingers, bad text..."/></div>
        <div class="in"><input id="template" placeholder="Template: {subject}, {shot}, {place} ... (optional)"/></div>
      </div>

      <div class="actions">
        <button class="abtn" id="genPromptsBtn">Generate prompts</button>
        <button class="abtn" id="genImagesBtn">Generate images</button>
        <button class="abtn alt" id="copyPromptsBtn" disabled>Copy prompts</button>
        <button class="abtn danger" id="stopBtn">STOP</button>
      </div>
    </div>
  </div>

  <!-- Modal key -->
  <div class="modal" id="modal">
    <div class="box">
      <h3>Gemini API key</h3>
      <p>Ключ нужен только для генерации изображений (REST использует заголовок <code>x-goog-api-key</code>). Качество 1K/2K/4K задаётся через <code>imageConfig.imageSize</code> и <b>K</b> должна быть заглавной. [page:0]</p>
      <div class="row2">
        <input id="apiKeyInput" placeholder="AIza..."/>
        <button class="save" id="saveKey">Save</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // State
  // =========================
  const state = {
    model: "gemini-3-pro-image-preview",
    aspectRatio: "16:9",
    imageSize: "1K",        // 1K/2K/4K (uppercase K) [page:0]
    realismLock: true,      // Ultra realism lock ON by default
    reference: null,
    abort: null,
    prompts: []
  };

  const $ = (id) => document.getElementById(id);
  const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function uuid(){
    return (crypto?.randomUUID ? crypto.randomUUID() : (Date.now() + "-" + Math.random().toString(16).slice(2)));
  }

  // =========================
  // Toggle wiring
  // =========================
  function wireToggle(groupId, attr, setter){
    const root = $(groupId);
    root.querySelectorAll("button.tbtn").forEach(btn => {
      btn.addEventListener("click", () => {
        root.querySelectorAll("button.tbtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        setter(btn.getAttribute(attr));
      });
    });
  }
  wireToggle("modelGroup","data-model",(v)=>state.model=v);
  wireToggle("ratioGroup","data-ratio",(v)=>state.aspectRatio=v);
  wireToggle("sizeGroup","data-size",(v)=>state.imageSize=v);
  wireToggle("realismGroup","data-realism",(v)=>state.realismLock = (v === "on"));

  // sliders
  $("countRange").addEventListener("input", e => $("countVal").textContent = e.target.value);
  $("concRange").addEventListener("input", e => $("concVal").textContent = e.target.value);

  // grid controls
  function setCols(n){
    document.documentElement.style.setProperty("--cols", n);
    $("colsVal").textContent = n;
  }
  function setTile(px){
    document.documentElement.style.setProperty("--thumbH", px + "px");
    $("tileVal").textContent = px;
  }
  $("colsRange").addEventListener("input", e => setCols(e.target.value));
  $("tileRange").addEventListener("input", e => setTile(e.target.value));
  setCols($("colsRange").value);
  setTile($("tileRange").value);

  // =========================
  // Progress
  // =========================
  function setProgress(done,total){
    const pct = total ? Math.round(done/total*100) : 0;
    $("bar").style.width = pct + "%";
    $("stat").textContent = `${done}/${total} (${pct}%)`;
  }
  setProgress(0, 1);

  // =========================
  // API key modal (only for images)
  // =========================
  function getKey(){ return sessionStorage.getItem("GEMINI_API_KEY") || ""; }
  function requireKeyForImages(){
    if (!getKey()) $("modal").style.display = "flex";
    return !!getKey();
  }
  $("keyBtn").onclick = () => { $("modal").style.display = "flex"; };
  $("saveKey").onclick = () => {
    const k = $("apiKeyInput").value.trim();
    if (!k) return;
    sessionStorage.setItem("GEMINI_API_KEY", k);
    $("apiKeyInput").value = "";
    $("modal").style.display = "none";
  };

  // =========================
  // Upload reference
  // =========================
  const dropZone = $("dropZone");
  const fileInput = $("fileInput");
  const preview = $("preview");

  dropZone.addEventListener("click", () => fileInput.click());
  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.style.borderColor = "var(--accent)"; });
  dropZone.addEventListener("dragleave", () => { dropZone.style.borderColor = "var(--border)"; });
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault(); dropZone.style.borderColor = "var(--border)";
    const f = e.dataTransfer.files?.[0]; if (f) loadFile(f);
  });
  fileInput.addEventListener("change", (e) => {
    const f = e.target.files?.[0]; if (f) loadFile(f);
  });

  function loadFile(file){
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = String(e.target.result);
      preview.src = dataUrl;
      preview.style.display = "block";
      $("uploadText").style.display = "none";
      const [meta, b64] = dataUrl.split(",");
      const mime = meta.match(/data:(.*);base64/)?.[1] || "image/png";
      state.reference = { mimeType: mime, base64: b64 };
    };
    reader.readAsDataURL(file);
  }

  // =========================
  // Ultra realism lock strings
  // =========================
  const REALISM_CORE = [
    "photorealistic DSLR photo",
    "ultra realistic",
    "natural skin texture",
    "visible pores in close-ups",
    "fine vellus hair (peach fuzz)",
    "subtle natural imperfections",
    "realistic color science",
    "true-to-life lighting",
    "sharp micro-contrast",
    "natural depth of field",
    "authentic high-end Instagram editorial look",
    "realistic shadows and reflections"
  ].join(", ");

  const REALISM_NEGATIVE = [
    "cartoon","anime","illustration","cgi","3d","render",
    "plastic skin","airbrushed","over-smoothed skin","wax skin",
    "doll-like","uncanny","painterly",
    "lowres","blurry","pixelated","overprocessed",
    "watermark","logo","text","bad typography"
  ].join(", ");

  // =========================
  // Prompt DB (шире = меньше похожих сюжетов)
  // =========================
  const db = {
    subject: [
      "female model", "male model", "androgynous model",
      "street photographer", "fashion stylist", "creative director",
      "chef", "architect", "barista", "boxer", "dancer"
    ],
    shot: [
      "extreme close-up portrait", "close-up portrait", "half-body portrait",
      "full body street shot", "candid lifestyle shot", "editorial lookbook shot"
    ],
    action: [
      "standing confidently", "walking dynamically", "sitting elegantly",
      "looking over shoulder", "laughing candidly", "serious editorial pose",
      "adjusting jacket", "fixing hair", "checking phone"
    ],
    emotion: ["calm", "confident", "playful", "mysterious", "soft smile", "serious"],
    wardrobe: [
      "oversized blazer", "tailored suit", "white linen shirt",
      "cashmere turtleneck", "leather biker jacket", "minimal black coat",
      "luxury streetwear jacket", "simple fitted t-shirt"
    ],
    palette: [
      "neutral tones", "monochrome black", "warm earth tones",
      "navy & gold accents", "soft beige and cream", "desaturated cinematic colors"
    ],
    place: [
      "night city street", "minimalist studio", "rooftop skyline",
      "underground parking", "old library", "art gallery",
      "boutique storefront", "subway entrance", "hotel lobby", "industrial loft"
    ],
    background: [
      "busy street bokeh", "minimal concrete wall", "glass reflections",
      "neon signage bokeh", "soft city lights", "clean architectural lines",
      "rainy asphalt reflections", "warm indoor lamps"
    ],
    time: [
      "early morning", "midday", "golden hour sunset",
      "blue hour", "night", "rainy evening", "foggy morning"
    ],
    weather: [
      "clear air", "light rain", "mist in the air",
      "wet asphalt reflections", "soft haze", "crisp winter air"
    ],
    lighting: [
      "soft window light", "golden hour", "blue hour",
      "neon rim light", "hard on-camera flash", "cinematic shadows",
      "overcast diffused light"
    ],
    lens: ["35mm", "50mm", "85mm", "24mm wide angle"],
    aperture: ["f/1.8", "f/2.0", "f/2.8", "f/4"],
    camera: ["Sony A7R IV", "Leica M11", "Canon R5", "Nikon Z8", "iPhone 15 Pro"],
    props: [
      "holding an iced coffee", "holding a phone", "earbuds",
      "small handbag", "newspaper", "umbrella", "vintage camera",
      "shopping bag", "sunglasses"
    ],
    details: [
      "clean manicure", "natural eyebrows", "subtle makeup",
      "natural lip texture", "realistic fabric weave", "fine hair strands",
      "realistic eye reflections (catchlights)", "authentic street styling"
    ]
  };

  // Template support (optional)
  function applyTemplate(tpl, v){
    return tpl
      .replaceAll("{subject}", v.subject)
      .replaceAll("{shot}", v.shot)
      .replaceAll("{action}", v.action)
      .replaceAll("{emotion}", v.emotion)
      .replaceAll("{wardrobe}", v.wardrobe)
      .replaceAll("{palette}", v.palette)
      .replaceAll("{place}", v.place)
      .replaceAll("{background}", v.background)
      .replaceAll("{time}", v.time)
      .replaceAll("{weather}", v.weather)
      .replaceAll("{lighting}", v.lighting)
      .replaceAll("{lens}", v.lens)
      .replaceAll("{aperture}", v.aperture)
      .replaceAll("{camera}", v.camera)
      .replaceAll("{prop}", v.prop)
      .replaceAll("{details}", v.details);
  }

  // Уникальная "сигнатура сюжета" (чтобы не было похожих сцен)
  function signature(v){
    return [
      v.subject, v.shot, v.place, v.time, v.weather,
      v.lighting, v.wardrobe, v.prop, v.background
    ].join("|").toLowerCase();
  }

  function buildPromptFromVars(v, base, avoid, tpl){
    const baseLine = (base || "").trim() ? base.trim() + ". " : "";

    const scene = (tpl && tpl.includes("{subject}"))
      ? applyTemplate(tpl, v)
      : `${v.subject}, ${v.shot}, ${v.action}, emotion: ${v.emotion}. ` +
        `Wearing: ${v.wardrobe} (palette: ${v.palette}). ` +
        `Location: ${v.place}; background: ${v.background}. ` +
        `Time: ${v.time}; atmosphere: ${v.weather}. ` +
        `Lighting: ${v.lighting}. ` +
        `Lens: ${v.lens}, aperture: ${v.aperture}. ` +
        `Camera: ${v.camera}. ` +
        `Prop: ${v.prop}. ` +
        `Details: ${v.details}.`;

    const refLine = state.reference
      ? "Use the attached reference image; keep the same identity and key facial features. Keep skin texture natural; do not beautify or smooth skin."
      : "";

    const uniq = `Unique tag: ${uuid()}.`;

    if (state.realismLock){
      const userAvoid = (avoid || "").trim();
      const avoidLine = `Avoid: ${REALISM_NEGATIVE}${userAvoid ? ", " + userAvoid : ""}.`;
      return `${baseLine}${scene} ${REALISM_CORE}. ${refLine} ${avoidLine} ${uniq}`.replace(/\s+/g," ").trim();
    } else {
      const avoidLine = (avoid || "").trim() ? `Avoid: ${avoid.trim()}.` : "";
      return `${baseLine}${scene} ${refLine} ${avoidLine} ${uniq}`.replace(/\s+/g," ").trim();
    }
  }

  // Генерация промтов с анти-повторами (и "окном" недавних мест)
  function generateUniquePrompts(count, base, avoid, tpl){
    const used = new Set();
    const prompts = [];
    const recentPlaces = [];
    const recentWindow = Math.min(12, Math.max(6, Math.floor(count / 6)));

    for (let i = 0; i < count; i++){
      let tries = 0;
      let v, sig;

      while (true){
        v = {
          subject: rand(db.subject),
          shot: rand(db.shot),
          action: rand(db.action),
          emotion: rand(db.emotion),
          wardrobe: rand(db.wardrobe),
          palette: rand(db.palette),
          place: rand(db.place),
          background: rand(db.background),
          time: rand(db.time),
          weather: rand(db.weather),
          lighting: rand(db.lighting),
          lens: rand(db.lens),
          aperture: rand(db.aperture),
          camera: rand(db.camera),
          prop: rand(db.props),
          details: rand(db.details)
        };

        sig = signature(v);
        const placeTooSoon = recentPlaces.includes(v.place);

        tries++;
        const ok = !used.has(sig) && !placeTooSoon;
        if (ok || tries > 60) break;
      }

      used.add(sig);

      recentPlaces.push(v.place);
      while (recentPlaces.length > recentWindow) recentPlaces.shift();

      prompts.push(buildPromptFromVars(v, base, avoid, tpl));
    }

    return prompts;
  }

  // =========================
  // Render cards
  // =========================
  function makeCard(i, prompt){
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="thumb" id="thumb_${i}">Prompt ready</div>
      <div class="meta">
        <div class="tag">#${i+1} · ${state.model} · ${state.aspectRatio} · ${state.imageSize} · realism:${state.realismLock ? "ON" : "off"}</div>
        <pre id="p_${i}"></pre>
      </div>
      <div class="mini">
        <button class="mbtn" id="cp_${i}">Copy prompt</button>
        <button class="mbtn" id="dl_${i}" disabled>Download</button>
      </div>
    `;
    el.querySelector(`#p_${i}`).textContent = prompt;
    el.querySelector(`#cp_${i}`).onclick = () => navigator.clipboard.writeText(prompt);
    return el;
  }

  async function setThumbImage(i, mime, base64){
    const thumb = $(`thumb_${i}`);
    const url = `data:${mime};base64,${base64}`;
    thumb.innerHTML = "";
    const im = document.createElement("img");
    im.src = url;
    thumb.appendChild(im);

    const dl = $(`dl_${i}`);
    dl.disabled = false;
    dl.onclick = () => {
      const a = document.createElement("a");
      a.href = url;
      a.download = `nanobanana_${String(i+1).padStart(3,"0")}.png`;
      a.click();
    };
  }

  // =========================
  // Gemini REST (direct)
  // =========================
  function pickFinalImagePart(j){
    const parts = j?.candidates?.[0]?.content?.parts || [];
    for (let k = parts.length - 1; k >= 0; k--){
      const p = parts[k];
      if (p?.inlineData?.data && p?.inlineData?.mimeType && !p.thought) {
        return { base64: p.inlineData.data, mime: p.inlineData.mimeType };
      }
    }
    for (let k = parts.length - 1; k >= 0; k--){
      const p = parts[k];
      if (p?.inlineData?.data && p?.inlineData?.mimeType) {
        return { base64: p.inlineData.data, mime: p.inlineData.mimeType };
      }
    }
    return null;
  }

  async function generateOne(prompt, signal){
    const apiKey = getKey();
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(state.model)}:generateContent`;

    const parts = [{ text: prompt }];
    if (state.reference) {
      parts.push({ inline_data: { mime_type: state.reference.mimeType, data: state.reference.base64 } });
    }

    const payload = {
      contents: [{ role: "user", parts }],
      generationConfig: {
        responseModalities: ["TEXT","IMAGE"],
        imageConfig: { aspectRatio: state.aspectRatio, imageSize: state.imageSize } // 1K/2K/4K [page:0]
      }
    };

    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json", "x-goog-api-key": apiKey }, // [page:0]
      body: JSON.stringify(payload),
      signal
    });

    const j = await r.json().catch(()=> ({}));
    if (!r.ok) {
      const msg = j?.error?.message || `HTTP ${r.status}`;
      const e = new Error(msg);
      e.status = r.status;
      throw e;
    }

    const img = pickFinalImagePart(j);
    if (!img) throw new Error("No image in response");
    return img;
  }

  // =========================
  // Batch runners
  // =========================
  async function runPromptsOnly(){
    const count = Number($("countRange").value);
    const base  = $("basePrompt").value;
    const avoid = $("avoid").value;
    const tpl   = $("template").value;

    state.prompts = generateUniquePrompts(count, base, avoid, tpl);
    window.__PROMPTS_TXT = state.prompts.join("\n\n");

    const grid = $("grid");
    grid.innerHTML = "";
    state.prompts.forEach((p,i)=> grid.appendChild(makeCard(i,p)));

    $("copyPromptsBtn").disabled = false;
    $("stopBtn").style.display = "none";
    setProgress(count, count);
  }

  async function runImages(){
    if (!requireKeyForImages()) return;

    const count = Number($("countRange").value);
    const conc  = Number($("concRange").value);
    const base  = $("basePrompt").value;
    const avoid = $("avoid").value;
    const tpl   = $("template").value;

    state.prompts = generateUniquePrompts(count, base, avoid, tpl);
    window.__PROMPTS_TXT = state.prompts.join("\n\n");

    const grid = $("grid");
    grid.innerHTML = "";
    state.prompts.forEach((p,i)=> grid.appendChild(makeCard(i,p)));

    $("copyPromptsBtn").disabled = false;

    state.abort = new AbortController();
    $("stopBtn").style.display = "inline-block";
    $("genImagesBtn").disabled = true;
    $("genPromptsBtn").disabled = true;

    let done = 0;
    let idx = 0;
    setProgress(0, count);

    async function worker(){
      while (idx < count) {
        const i = idx++;
        const thumb = $(`thumb_${i}`);
        try{
          thumb.textContent = "Generating…";

          let attempt = 0;
          while (true) {
            try{
              const img = await generateOne(state.prompts[i], state.abort.signal);
              await setThumbImage(i, img.mime, img.base64);
              break;
            } catch(e){
              attempt++;
              const status = e.status || 0;
              if ((status === 429 || status === 503) && attempt <= 6) {
                const backoff = Math.min(9000, 600 * Math.pow(2, attempt));
                thumb.textContent = `Rate limit… retry in ${Math.round(backoff/1000)}s`;
                await sleep(backoff);
                continue;
              }
              throw e;
            }
          }

        } catch(e){
          thumb.textContent = "Error: " + String(e.message || e);
          thumb.style.color = "var(--bad)";
        } finally {
          done++;
          setProgress(done, count);
          await sleep(30);
        }
      }
    }

    try{
      await Promise.all(Array.from({length: conc}, worker));
    } finally {
      $("stopBtn").style.display = "none";
      $("genImagesBtn").disabled = false;
      $("genPromptsBtn").disabled = false;
      state.abort = null;
    }
  }

  $("stopBtn").onclick = () => { if (state.abort) state.abort.abort(); };

  $("genPromptsBtn").onclick = runPromptsOnly;
  $("genImagesBtn").onclick = runImages;

  $("copyPromptsBtn").onclick = async () => {
    if (window.__PROMPTS_TXT) await navigator.clipboard.writeText(window.__PROMPTS_TXT);
  };
</script>
</body>
</html>
