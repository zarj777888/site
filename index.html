<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NanoBanana Pro — Ultra Realism Batch Studio</title>

  <style>
    :root{
      --bg:#080808;
      --panel:#141414;
      --input:#1f1f1f;
      --border:#2e2e2e;
      --accent:#ccff00;

      --text:#ffffff;
      --dim:#a8a8a8;
      --placeholder:#909090;
      --bad:#ff4d4d;

      /* grid controls */
      --cols: 3;
      --thumbH: 240px;

      /* dock */
      --dockH: 262px;
    }

    *{box-sizing:border-box;}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:Inter,system-ui,-apple-system,sans-serif;
      margin:0;
      padding:18px;
      padding-bottom: calc(var(--dockH) + 24px);
    }

    .wrap{max-width:1220px; margin:0 auto;}
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.55);
    }

    /* ---------- TOP AREA ---------- */
    .upload{
      height:200px;
      border:2px dashed var(--border);
      border-radius:16px;
      cursor:pointer;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:rgba(255,255,255,.02);
      transition:.2s;
      margin-bottom:12px;
    }
    .upload:hover{border-color:var(--accent); background:rgba(204,255,0,.05);}
    .upload p{color:var(--dim); margin:0; font-size:14px;}
    #fileInput{display:none;}
    #preview{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; display:none;}

    .out{margin-top:12px;}
    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .progress{
      flex:1;
      min-width:260px;
      height:10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#101010;
      overflow:hidden;
    }
    .progress > div{height:100%; width:0%; background:var(--accent);}
    .stat{
      color:var(--dim);
      font-size:13px;
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(var(--cols), minmax(0, 1fr));
      gap:12px;
    }
    @media(max-width:950px){ :root{ --cols: 2; } }
    @media(max-width:560px){ :root{ --cols: 1; } }

    .card{
      background:#0f0f0f;
      border:1px solid #1e1e1e;
      border-radius:14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .thumb{
      height:var(--thumbH);
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#9a9a9a;
      font-size:12px;
      padding:10px;
      text-align:center;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .meta{padding:12px;}
    .tag{
      color:#a0a0a0;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1px;
    }
    pre{
      margin:8px 0 0 0;
      white-space:pre-wrap;
      word-break:break-word;
      color:#d6d6d6;
      font-size:12.5px;
      line-height:1.35;
      font-family:ui-monospace,Consolas,monospace;
      max-height:160px;
      overflow:auto;
      padding-right:6px;
    }
    .mini{
      display:flex;
      gap:10px;
      padding:12px;
      padding-top:0;
    }
    .mbtn{
      flex:1;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#000;
      color:#eaeaea;
      cursor:pointer;
      font-weight:950;
      font-size:12px;
    }
    .mbtn:hover{border-color:var(--accent); color:#fff;}
    .mbtn:disabled{opacity:.4; cursor:not-allowed;}

    /* ---------- DOCK (BOTTOM FIXED) ---------- */
    .dock{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:14px 18px;
      background: rgba(16,16,16,.82);
      border-top: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .dock .wrap{max-width:1220px; margin:0 auto;}
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .group{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .label{
      font-size:12px;
      font-weight:950;
      color:var(--dim);
      text-transform:uppercase;
      letter-spacing:1px;
    }
    .btns{
      display:flex;
      background:#000;
      border:1px solid var(--border);
      border-radius:10px;
      padding:4px;
    }
    .tbtn{
      background:transparent;
      border:0;
      color:#c8c8c8;
      padding:8px 14px;
      font-weight:950;
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
      transition:.12s;
    }
    .tbtn:hover{color:#fff;}
    .tbtn.active{background:var(--accent); color:#000;}

    .in{
      flex:1;
      min-width:260px;
      display:flex;
      align-items:center;
      background:var(--input);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      padding:0 12px;
    }
    .in:focus-within{border-color: rgba(204,255,0,.35);}
    .in input{
      width:100%;
      background:transparent;
      border:0;
      outline:0;
      color:#fff;
      padding:14px 0;
      font-size:14px;
    }
    .in input::placeholder{color:var(--placeholder);}

    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;}
    .abtn{
      height:46px;
      padding:0 18px;
      border-radius:12px;
      border:0;
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      background:#2d2d2d;
      color:#d6d6d6;
      transition:.12s;
    }
    .abtn:hover{background:var(--accent); color:#000;}
    .abtn.alt{background:#000; border:1px solid var(--border); color:#f0f0f0;}
    .abtn.alt:hover{border-color:var(--accent); color:#fff;}
    .abtn.danger{
      background:transparent;
      border:1px solid var(--bad);
      color:var(--bad);
      display:none;
    }
    .abtn.danger:hover{background:rgba(255,77,77,.10);}

    .slider{
      display:flex;
      align-items:center;
      gap:10px;
      background:#000;
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 12px;
    }
    input[type=range]{
      -webkit-appearance:none;
      width:140px;
      height:4px;
      background:#333;
      border-radius:2px;
      outline:none;
    }
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:16px; height:16px;
      border-radius:50%;
      background:var(--accent);
      cursor:pointer;
      box-shadow:0 0 10px rgba(204,255,0,.5);
    }
    .mono{
      font-family:ui-monospace,Consolas,monospace;
      font-weight:950;
      color:var(--accent);
      width:42px;
      text-align:right;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.68);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .box{
      width:100%;
      max-width:620px;
      background:#0f0f0f;
      border:1px solid #222;
      border-radius:18px;
      padding:16px;
      box-shadow:0 25px 80px rgba(0,0,0,.6);
      position:relative;
    }
    .box h3{margin:0 0 8px 0; font-size:16px;}
    .box p{margin:0 0 12px 0; color:#a0a0a0; font-size:13px; line-height:1.35;}
    .box .row2{display:flex; gap:10px; flex-wrap:wrap;}
    .box input{
      flex:1; min-width:260px;
      background:#000;
      border:1px solid #333;
      border-radius:12px;
      padding:12px 14px;
      color:#fff;
      outline:none;
      font-family:ui-monospace,Consolas,monospace;
    }
    .save{
      height:44px;
      padding:0 16px;
      border-radius:12px;
      border:0;
      background:var(--accent);
      color:#000;
      font-weight:950;
      cursor:pointer;
    }
    .closeX{
      position:absolute;
      top:10px;
      right:10px;
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid #2a2a2a;
      background:#000;
      color:#ddd;
      cursor:pointer;
      font-size:18px;
      line-height:1;
      font-weight:900;
    }
    .closeX:hover{
      border-color:var(--accent);
      color:#fff;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="upload panel" id="dropZone">
      <p id="uploadText">Нажми или перетащи сюда фото (Reference optional)</p>
      <img id="preview" alt="preview"/>
      <input type="file" id="fileInput" accept="image/*"/>
    </div>

    <div class="panel out" id="output">
      <div class="topbar">
        <div class="progress"><div id="bar"></div></div>
        <div class="stat" id="stat">Idle</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Dock bottom -->
  <div class="dock">
    <div class="wrap">
      <div class="row">
        <div class="group">
          <span class="label">Model</span>
          <div class="btns" id="modelGroup">
            <button class="tbtn active" data-model="gemini-3-pro-image-preview">Pro</button>
            <button class="tbtn" data-model="gemini-2.5-flash-image">Flash</button>
          </div>
        </div>

        <div class="group">
          <span class="label">Ratio</span>
          <div class="btns" id="ratioGroup">
            <button class="tbtn active" data-ratio="1:1">1:1</button>
            <button class="tbtn" data-ratio="3:4">3:4</button>
            <button class="tbtn" data-ratio="4:3">4:3</button>
            <button class="tbtn" data-ratio="16:9">16:9</button>
            <button class="tbtn" data-ratio="9:16">9:16</button>
          </div>
        </div>

        <div class="group">
          <span class="label">Quality</span>
          <div class="btns" id="sizeGroup">
            <button class="tbtn" data-size="1K">1K</button>
            <button class="tbtn" data-size="2K">2K</button>
            <button class="tbtn active" data-size="4K">4K</button>
          </div>
        </div>

        <div class="group">
          <span class="label">Realism</span>
          <div class="btns" id="realismGroup">
            <button class="tbtn active" data-realism="on">Ultra ON</button>
            <button class="tbtn" data-realism="off">OFF</button>
          </div>
        </div>

        <div class="group">
          <span class="label">Count</span>
          <div class="slider">
            <span class="mono" id="countVal">4</span>
            <input type="range" id="countRange" min="1" max="200" value="4"/>
          </div>
        </div>

        <div class="group">
          <span class="label">Conc.</span>
          <div class="slider">
            <span class="mono" id="concVal">4</span>
            <input type="range" id="concRange" min="1" max="12" value="4"/>
          </div>
        </div>

        <div class="group">
          <span class="label">Cols</span>
          <div class="slider">
            <span class="mono" id="colsVal">3</span>
            <input type="range" id="colsRange" min="1" max="6" value="3"/>
          </div>
        </div>

        <div class="group">
          <span class="label">Tile</span>
          <div class="slider">
            <span class="mono" id="tileVal">240</span>
            <input type="range" id="tileRange" min="140" max="440" value="240"/>
          </div>
        </div>

        <div class="group">
          <span class="label">Key</span>
          <button class="abtn alt" id="keyBtn">Set API key</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="in"><input id="basePrompt" placeholder="Base prompt (например: high-end Instagram portrait, clean minimal styling)"/></div>
        <div class="in"><input id="avoid" placeholder="Avoid (через запятую): watermark, blurry, extra fingers, bad text..."/></div>
        <div class="in"><input id="template" placeholder="(optional) Add-on: 'black nails, silver earrings, minimal makeup'"/></div>
      </div>

      <div class="actions">
        <button class="abtn" id="genPromptsBtn">Generate prompts</button>
        <button class="abtn" id="genImagesBtn">Generate images</button>
        <button class="abtn alt" id="copyPromptsBtn" disabled>Copy prompts</button>
        <button class="abtn danger" id="stopBtn">STOP</button>
      </div>
    </div>
  </div>

  <!-- Modal key -->
  <div class="modal" id="modal">
    <div class="box" role="dialog" aria-modal="true" aria-label="API key">
      <button class="closeX" id="closeModal" aria-label="Close">×</button>
      <h3>Gemini API key</h3>
      <p>Ключ нужен только для генерации изображений. Ввод сохраняется в sessionStorage (только в этой вкладке).</p>
      <div class="row2">
        <input id="apiKeyInput" placeholder="AIza..."/>
        <button class="save" id="saveKey">Save</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // State (defaults requested)
  // =========================
  const state = {
    model: "gemini-3-pro-image-preview",
    aspectRatio: "1:1",    // default 1:1
    imageSize: "4K",       // default 4K
    realismLock: true,     // default ON
    reference: null,
    abort: null,
    prompts: []
  };

  const $ = (id) => document.getElementById(id);
  const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function uuid(){
    return (crypto?.randomUUID ? crypto.randomUUID() : (Date.now() + "-" + Math.random().toString(16).slice(2)));
  }

  // =========================
  // Toggle wiring
  // =========================
  function wireToggle(groupId, attr, setter){
    const root = $(groupId);
    root.querySelectorAll("button.tbtn").forEach(btn => {
      btn.addEventListener("click", () => {
        root.querySelectorAll("button.tbtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        setter(btn.getAttribute(attr));
      });
    });
  }
  wireToggle("modelGroup","data-model",(v)=>state.model=v);
  wireToggle("ratioGroup","data-ratio",(v)=>state.aspectRatio=v);
  wireToggle("sizeGroup","data-size",(v)=>state.imageSize=v);
  wireToggle("realismGroup","data-realism",(v)=>state.realismLock = (v === "on"));

  // sliders
  $("countRange").addEventListener("input", e => $("countVal").textContent = e.target.value);
  $("concRange").addEventListener("input", e => $("concVal").textContent = e.target.value);

  // grid controls
  function setCols(n){
    document.documentElement.style.setProperty("--cols", n);
    $("colsVal").textContent = n;
  }
  function setTile(px){
    document.documentElement.style.setProperty("--thumbH", px + "px");
    $("tileVal").textContent = px;
  }
  $("colsRange").addEventListener("input", e => setCols(e.target.value));
  $("tileRange").addEventListener("input", e => setTile(e.target.value));
  setCols($("colsRange").value);
  setTile($("tileRange").value);

  // Ensure count label matches default slider value on load
  $("countVal").textContent = $("countRange").value;
  $("concVal").textContent = $("concRange").value;

  // =========================
  // Progress
  // =========================
  function setProgress(done,total){
    const pct = total ? Math.round(done/total*100) : 0;
    $("bar").style.width = pct + "%";
    $("stat").textContent = `${done}/${total} (${pct}%)`;
  }
  setProgress(0, 1);

  // =========================
  // API key modal (closeable)
  // =========================
  function getKey(){ return sessionStorage.getItem("GEMINI_API_KEY") || ""; }

  function openModal(){
    $("modal").style.display = "flex";
    setTimeout(() => $("apiKeyInput").focus(), 0);
  }
  function closeModal(){
    $("modal").style.display = "none";
  }

  function requireKeyForImages(){
    if (!getKey()) {
      openModal();
      return false;
    }
    return true;
  }

  $("keyBtn").onclick = openModal;
  $("closeModal").onclick = closeModal;

  // close on backdrop click
  $("modal").addEventListener("click", (e) => {
    if (e.target === $("modal")) closeModal();
  });

  // close on Escape
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });

  $("saveKey").onclick = () => {
    const k = $("apiKeyInput").value.trim();
    if (!k) { closeModal(); return; }
    sessionStorage.setItem("GEMINI_API_KEY", k);
    $("apiKeyInput").value = "";
    closeModal();
  };

  // =========================
  // Upload reference
  // =========================
  const dropZone = $("dropZone");
  const fileInput = $("fileInput");
  const preview = $("preview");

  dropZone.addEventListener("click", () => fileInput.click());
  dropZone.addEventListener("dragover", (e) => { e.preventDefault(); dropZone.style.borderColor = "var(--accent)"; });
  dropZone.addEventListener("dragleave", () => { dropZone.style.borderColor = "var(--border)"; });
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault(); dropZone.style.borderColor = "var(--border)";
    const f = e.dataTransfer.files?.[0]; if (f) loadFile(f);
  });
  fileInput.addEventListener("change", (e) => {
    const f = e.target.files?.[0]; if (f) loadFile(f);
  });

  function loadFile(file){
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = String(e.target.result);
      preview.src = dataUrl;
      preview.style.display = "block";
      $("uploadText").style.display = "none";
      const [meta, b64] = dataUrl.split(",");
      const mime = meta.match(/data:(.*);base64/)?.[1] || "image/png";
      state.reference = { mimeType: mime, base64: b64 };
    };
    reader.readAsDataURL(file);
  }

  // =========================
  // Ultra realism lock strings
  // =========================
  const REALISM_CORE = [
    "photorealistic DSLR photo",
    "ultra realistic",
    "natural skin texture",
    "visible pores in close-ups",
    "fine vellus hair (peach fuzz)",
    "subtle natural imperfections",
    "realistic color science",
    "true-to-life lighting",
    "sharp micro-contrast",
    "natural depth of field",
    "authentic high-end Instagram editorial look",
    "realistic shadows and reflections",
    "realistic material response (fabric, skin specular, glass reflections)"
  ].join(", ");

  const REALISM_NEGATIVE = [
    "cartoon","anime","illustration","cgi","3d","render",
    "plastic skin","airbrushed","over-smoothed skin","wax skin",
    "doll-like","uncanny","painterly",
    "lowres","blurry","pixelated","overprocessed",
    "watermark","logo","text","bad typography"
  ].join(", ");

  // =========================
  // Prompt DB (вариативность)
  // =========================
  const db = {
    subject: [
      "female subject", "male subject", "androgynous subject",
      "fashion model", "creative director", "street photographer",
      "barista", "architect", "dancer", "boxer"
    ],
    wardrobe: [
      "oversized blazer", "tailored suit", "white linen shirt",
      "cashmere turtleneck", "leather biker jacket", "minimal black coat",
      "luxury streetwear jacket", "simple fitted t-shirt"
    ],
    palette: [
      "neutral tones", "monochrome black", "warm earth tones",
      "soft beige and cream", "desaturated cinematic colors", "navy & gold accents"
    ],
    props: [
      "no accessories", "subtle jewelry", "small handbag", "sunglasses",
      "phone in hand", "coffee cup", "umbrella", "newspaper", "vintage camera"
    ],
    details: [
      "natural eyebrows", "subtle makeup", "natural lip texture",
      "realistic fabric weave", "fine hair strands", "realistic catchlights",
      "clean manicure", "natural flyaway hairs"
    ],
    microVariation: [
      "slight head tilt", "gentle shoulder angle", "micro expression change",
      "soft breathing realism", "tiny asymmetry preserved", "authentic posture"
    ]
  };

  // =========================
  // Pose presets (твоя инструкция)
  // =========================
  const POSE_PRESETS = [
    // Close-up / Face angles
    { id:"cu_frontal", cat:"closeup", label:"Frontal tight headshot",
      text:"Tight headshot, camera straight on, neutral expression, 85mm portrait look, shallow depth of field (f/2.0), even soft light, neutral grey background." },
    { id:"cu_34_left", cat:"closeup", label:"3/4 view left",
      text:"Close-up 3/4 view facing left, chin slightly down, eyes to camera, 85mm portrait, soft wrap light, clean studio background." },
    { id:"cu_34_right", cat:"closeup", label:"3/4 view right",
      text:"Close-up 3/4 view facing right, relaxed mouth, catchlights visible, gentle rim light on hair, simple backdrop." },
    { id:"cu_profile_left", cat:"closeup", label:"Profile left",
      text:"Clean profile (left side), ear visible, hair neatly following the reference shape, beauty portrait lighting, uncluttered background." },
    { id:"cu_profile_right", cat:"closeup", label:"Profile right",
      text:"Clean profile (right side), neck elongated, hair silhouette matches reference, soft key + subtle rim, studio backdrop." },
    { id:"cu_high_angle", cat:"closeup", label:"High-angle close-up",
      text:"Close-up from a slightly high camera angle, subject looking up with eyes to lens, cheeks and hairline preserved, soft top light, minimal shadows." },
    { id:"cu_low_angle", cat:"closeup", label:"Low-angle close-up",
      text:"Close-up from a slightly low angle, subtle confident look, precise hair volume per reference, controlled contrast, neutral background." },
    { id:"cu_turn_eyes", cat:"closeup", label:"Face turned, eyes to lens",
      text:"Head turned 30° off-axis, eyes glancing back at camera, natural lips, exact hair flow and parting as reference, soft directional light." },
    { id:"cu_shoulders_smile", cat:"closeup", label:"Shoulders-up, gentle smile",
      text:"Shoulders-up portrait, gentle closed-lip smile, hair shape intact, soft front key, faint vignette, simple studio background." },
    { id:"cu_hand_chin", cat:"closeup", label:"Hand-to-chin pose",
      text:"Close-up, hand lightly touching chin without covering facial landmarks, hair strands preserved, balanced soft lighting, plain background." },

    // Full-body / Studio poses
    { id:"fb_standing_neutral", cat:"fullbody_studio", label:"Standing neutral pose",
      text:"Full-body shot, subject standing straight, arms relaxed at sides, facing camera, neutral expression, studio white background, even lighting." },
    { id:"fb_walking_forward", cat:"fullbody", label:"Walking forward",
      text:"Full-body walking pose, one foot forward, arms swinging naturally, looking at camera, street-like neutral background, daylight soft shadows." },
    { id:"fb_crossed_arms", cat:"fullbody_studio", label:"Crossed arms",
      text:"Full-body standing pose, arms crossed, confident neutral stance, camera straight-on, seamless grey background." },
    { id:"fb_hands_pockets", cat:"fullbody_studio", label:"Hands in pockets",
      text:"Full-body pose, both hands in pockets, relaxed neutral posture, natural hair preserved, simple studio backdrop." },
    { id:"fb_seated_chair", cat:"fullbody_studio", label:"Seated on chair",
      text:"Full-body seated on a plain chair, legs crossed casually, upper body upright, camera slightly lower angle, plain neutral background." },
    { id:"fb_hand_hip", cat:"fullbody_studio", label:"One hand on hip",
      text:"Full-body standing pose, one hand resting on hip, head slightly tilted, hair shape preserved, soft directional studio lighting." },
    { id:"fb_lean_wall", cat:"fullbody", label:"Leaning against wall",
      text:"Full-body leaning casually against a wall, arms relaxed, legs slightly crossed, natural confident look, urban minimal background." },
    { id:"fb_dynamic_step", cat:"fullbody", label:"Dynamic step to the side",
      text:"Full-body in mid-step to the side, arms in natural motion, body dynamic but identity intact, clean neutral background." },
    { id:"fb_hands_back", cat:"fullbody_studio", label:"Hands behind back",
      text:"Full-body standing pose, hands loosely clasped behind back, posture upright, calm facial expression, soft studio light." },
    { id:"fb_sitting_floor", cat:"fullbody_studio", label:"Sitting on floor pose",
      text:"Full-body seated on the floor, legs crossed casually, hands resting on knees, looking slightly up at camera, minimalistic background." },

    // Everyday / Lifestyle scenes
    { id:"ls_reading_bed", cat:"lifestyle", label:"Reading on bed",
      text:"Full-body shot, lying on bed on side, holding a book, relaxed expression, daylight from window, cozy bedroom background." },
    { id:"ls_stretch_wakeup", cat:"lifestyle", label:"Stretching after waking up",
      text:"Full-body pose on bed, arms stretched upward as if just waking up, natural daylight, minimalistic bedroom interior." },
    { id:"ls_cooking_kitchen", cat:"lifestyle", label:"Cooking in kitchen",
      text:"Full-body in a modern kitchen, standing by counter, stirring a pot, casual clothes, warm daylight entering room." },
    { id:"ls_desk_laptop", cat:"lifestyle", label:"Sitting at a desk with laptop",
      text:"Full-body sitting at home desk, typing on a laptop, posture upright but relaxed, natural sunlight from window." },
    { id:"ls_coffee_cafe", cat:"lifestyle", label:"Drinking coffee at café table",
      text:"Full-body seated at a small café table, cup of coffee in hand, casual expression, daylight, blurred background of café interior." },
    { id:"ls_look_window", cat:"lifestyle", label:"Looking out window",
      text:"Full-body pose standing near window, hands resting on sill, natural daylight illuminating face, home environment visible." },
    { id:"ls_sofa_phone", cat:"lifestyle", label:"Relaxed on sofa with phone",
      text:"Full-body lounging on sofa, holding phone, relaxed casual posture, warm daylight from side window." },
    { id:"ls_walk_cafe", cat:"lifestyle", label:"Walking in café interior",
      text:"Full-body walking pose inside café, tray in hand, natural soft lighting, wooden tables in background." },
    { id:"ls_bed_laptop", cat:"lifestyle", label:"Sitting cross-legged on bed with laptop",
      text:"Full-body on bed, sitting cross-legged, laptop open on lap, casual clothing, daylight streaming from window." },
    { id:"ls_kitchen_mug", cat:"lifestyle", label:"Leaning on kitchen counter with mug",
      text:"Full-body standing casually against kitchen counter, holding mug with both hands, natural daylight, modern cozy kitchen." },

    // Selfies
    { id:"sf_mirror_home", cat:"selfie", label:"Mirror selfie at home",
      text:"Selfie in mirror with phone in hand, full body visible, casual indoor background, natural daylight from window, relaxed expression." },
    { id:"sf_outdoor", cat:"selfie", label:"Outdoor selfie",
      text:"Handheld selfie outdoors, camera slightly above eye level, natural sunlight, blurred city street background, casual friendly smile." },
    { id:"sf_bedtime", cat:"selfie", label:"Bedtime selfie",
      text:"Close selfie while lying on bed, head resting on pillow, soft daylight from side window, neutral calm expression." },
    { id:"sf_cafe", cat:"selfie", label:"Café selfie",
      text:"Selfie at café table, cup of coffee in frame, warm ambient light, cozy modern café background, casual relaxed look." },

    // Laughing / Emotion
    { id:"em_laugh_close", cat:"emotion_closeup", label:"Laughing in close-up",
      text:"Tight portrait, subject laughing joyfully, teeth slightly visible, head tilted back a little, natural daylight, blurred neutral background." },
    { id:"em_laugh_full", cat:"emotion_fullbody", label:"Full-body casual laugh",
      text:"Full-body standing pose, subject mid-laughter, one hand near face, relaxed posture, daylight home environment background." },
    { id:"em_laugh_seated", cat:"emotion", label:"Sitting and laughing",
      text:"Seated pose, subject leaning slightly forward with laughter, hair preserved, cozy indoor background, warm natural light." }
  ];

  // =========================
  // Uniqueness helpers
  // =========================
  function signature(v){
    return [
      v.preset.id,
      v.subject,
      v.wardrobe,
      v.palette,
      v.extraProp,
      v.details,
      v.micro
    ].join("|").toLowerCase();
  }

  function buildPromptFromVars(v, base, avoid, addon){
    const baseLine = (base || "").trim() ? base.trim() + ". " : "";
    const extra = (addon || "").trim();

    const presetBlock = v.preset.text;

    const sceneAdd =
      `Subject: ${v.subject}. Wardrobe styling: ${v.palette} ${v.wardrobe}. ` +
      `Accessories/prop: ${v.extraProp}. Details: ${v.details}. ${v.micro}.` +
      (extra ? ` Additional notes: ${extra}.` : "");

    const refLine = state.reference
      ? "Use the attached reference image; keep the same identity and key facial features. Keep hair flow/parting consistent with the reference. Do not beautify or smooth skin."
      : "";

    const uniq = `Unique tag: ${uuid()}.`;

    if (state.realismLock){
      const poresLine = (v.preset.cat === "closeup" || v.preset.cat === "emotion_closeup")
        ? "Visible pores and natural micro-texture in close-ups, realistic skin specular highlights, no skin smoothing."
        : "Natural skin texture, true-to-life materials, realistic lighting and shadows.";

      const userAvoid = (avoid || "").trim();
      const avoidLine = `Avoid: ${REALISM_NEGATIVE}${userAvoid ? ", " + userAvoid : ""}.`;

      return `${baseLine}${presetBlock} ${sceneAdd} ${REALISM_CORE}. ${poresLine} ${refLine} ${avoidLine} ${uniq}`
        .replace(/\s+/g," ").trim();
    } else {
      const avoidLine = (avoid || "").trim() ? `Avoid: ${avoid.trim()}.` : "";
      return `${baseLine}${presetBlock} ${sceneAdd} ${refLine} ${avoidLine} ${uniq}`
        .replace(/\s+/g," ").trim();
    }
  }

  function generateUniquePrompts(count, base, avoid, addon){
    const used = new Set();
    const prompts = [];

    const presetsShuffled = [...POSE_PRESETS].sort(() => Math.random() - 0.5);

    const recentPreset = [];
    const recentCat = [];
    const recentWindowPreset = 10;
    const recentWindowCat = 6;

    for (let i = 0; i < count; i++){
      let tries = 0;
      let v, sig;

      while (true){
        let preset = presetsShuffled[i % presetsShuffled.length];

        if (count > presetsShuffled.length) {
          for (let t = 0; t < 30; t++){
            const p = rand(POSE_PRESETS);
            if (!recentPreset.includes(p.id) && !recentCat.includes(p.cat)) { preset = p; break; }
          }
        }

        v = {
          preset,
          subject: rand(db.subject),
          wardrobe: rand(db.wardrobe),
          palette: rand(db.palette),
          extraProp: rand(db.props),
          details: rand(db.details),
          micro: rand(db.microVariation)
        };

        sig = signature(v);
        tries++;

        if (!used.has(sig)) break;
        if (tries > 90) break;
      }

      used.add(sig);

      recentPreset.push(v.preset.id);
      while (recentPreset.length > recentWindowPreset) recentPreset.shift();

      recentCat.push(v.preset.cat);
      while (recentCat.length > recentWindowCat) recentCat.shift();

      prompts.push(buildPromptFromVars(v, base, avoid, addon));
    }

    return prompts;
  }

  // =========================
  // Render cards
  // =========================
  function makeCard(i, prompt){
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="thumb" id="thumb_${i}">Prompt ready</div>
      <div class="meta">
        <div class="tag">#${i+1} · ${state.model} · ${state.aspectRatio} · ${state.imageSize} · realism:${state.realismLock ? "ON" : "off"}</div>
        <pre id="p_${i}"></pre>
      </div>
      <div class="mini">
        <button class="mbtn" id="cp_${i}">Copy prompt</button>
        <button class="mbtn" id="dl_${i}" disabled>Download</button>
      </div>
    `;
    el.querySelector(`#p_${i}`).textContent = prompt;
    el.querySelector(`#cp_${i}`).onclick = () => navigator.clipboard.writeText(prompt);
    return el;
  }

  async function setThumbImage(i, mime, base64){
    const thumb = $(`thumb_${i}`);
    const url = `data:${mime};base64,${base64}`;
    thumb.innerHTML = "";
    const im = document.createElement("img");
    im.src = url;
    thumb.appendChild(im);

    const dl = $(`dl_${i}`);
    dl.disabled = false;
    dl.onclick = () => {
      const a = document.createElement("a");
      a.href = url;
      a.download = `nanobanana_${String(i+1).padStart(3,"0")}.png`;
      a.click();
    };
  }

  // =========================
  // Gemini REST (direct)
  // =========================
  function pickFinalImagePart(j){
    const parts = j?.candidates?.[0]?.content?.parts || [];
    for (let k = parts.length - 1; k >= 0; k--){
      const p = parts[k];
      if (p?.inlineData?.data && p?.inlineData?.mimeType && !p.thought) {
        return { base64: p.inlineData.data, mime: p.inlineData.mimeType };
      }
    }
    for (let k = parts.length - 1; k >= 0; k--){
      const p = parts[k];
      if (p?.inlineData?.data && p?.inlineData?.mimeType) {
        return { base64: p.inlineData.data, mime: p.inlineData.mimeType };
      }
    }
    return null;
  }

  async function generateOne(prompt, signal){
    const apiKey = getKey();
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(state.model)}:generateContent`;

    const parts = [{ text: prompt }];
    if (state.reference) {
      parts.push({ inline_data: { mime_type: state.reference.mimeType, data: state.reference.base64 } });
    }

    const payload = {
      contents: [{ role: "user", parts }],
      generationConfig: {
        responseModalities: ["TEXT","IMAGE"],
        imageConfig: { aspectRatio: state.aspectRatio, imageSize: state.imageSize }
      }
    };

    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json", "x-goog-api-key": apiKey },
      body: JSON.stringify(payload),
      signal
    });

    const j = await r.json().catch(()=> ({}));
    if (!r.ok) {
      const msg = j?.error?.message || `HTTP ${r.status}`;
      const e = new Error(msg);
      e.status = r.status;
      throw e;
    }

    const img = pickFinalImagePart(j);
    if (!img) throw new Error("No image in response");
    return img;
  }

  // =========================
  // Batch runners
  // =========================
  function renderPromptBatch(prompts){
    const grid = $("grid");
    grid.innerHTML = "";
    prompts.forEach((p,i)=> grid.appendChild(makeCard(i, p)));
  }

  async function runPromptsOnly(){
    const count = Number($("countRange").value);
    const base  = $("basePrompt").value;
    const avoid = $("avoid").value;
    const addon = $("template").value;

    state.prompts = generateUniquePrompts(count, base, avoid, addon);
    window.__PROMPTS_TXT = state.prompts.join("\n\n");

    renderPromptBatch(state.prompts);

    $("copyPromptsBtn").disabled = false;
    $("stopBtn").style.display = "none";
    setProgress(count, count);
  }

  async function runImages(){
    if (!requireKeyForImages()) return;

    const count = Number($("countRange").value);
    const conc  = Number($("concRange").value);
    const base  = $("basePrompt").value;
    const avoid = $("avoid").value;
    const addon = $("template").value;

    state.prompts = generateUniquePrompts(count, base, avoid, addon);
    window.__PROMPTS_TXT = state.prompts.join("\n\n");

    renderPromptBatch(state.prompts);
    $("copyPromptsBtn").disabled = false;

    state.abort = new AbortController();
    $("stopBtn").style.display = "inline-block";
    $("genImagesBtn").disabled = true;
    $("genPromptsBtn").disabled = true;

    let done = 0;
    let idx = 0;
    setProgress(0, count);

    async function worker(){
      while (idx < count) {
        const i = idx++;
        const thumb = $(`thumb_${i}`);
        try{
          thumb.textContent = "Generating…";

          let attempt = 0;
          while (true) {
            try{
              const img = await generateOne(state.prompts[i], state.abort.signal);
              await setThumbImage(i, img.mime, img.base64);
              break;
            } catch(e){
              attempt++;
              const status = e.status || 0;

              // If quota is 0, retries are pointless
              const msg = String(e.message || e);
              const zeroQuota = msg.includes("Quota exceeded") && msg.includes("limit: 0");
              if (zeroQuota) throw new Error("Quota is 0 for this model/project. Enable billing/upgrade tier, or switch model.");

              if ((status === 429 || status === 503) && attempt <= 6) {
                const backoff = Math.min(9000, 600 * Math.pow(2, attempt));
                thumb.textContent = `Rate limit… retry in ${Math.round(backoff/1000)}s`;
                await sleep(backoff);
                continue;
              }
              throw e;
            }
          }

        } catch(e){
          thumb.textContent = "Error: " + String(e.message || e);
          thumb.style.color = "var(--bad)";
        } finally {
          done++;
          setProgress(done, count);
          await sleep(30);
        }
      }
    }

    try{
      await Promise.all(Array.from({length: conc}, worker));
    } finally {
      $("stopBtn").style.display = "none";
      $("genImagesBtn").disabled = false;
      $("genPromptsBtn").disabled = false;
      state.abort = null;
    }
  }

  $("stopBtn").onclick = () => { if (state.abort) state.abort.abort(); };

  $("genPromptsBtn").onclick = runPromptsOnly;
  $("genImagesBtn").onclick = runImages;

  $("copyPromptsBtn").onclick = async () => {
    if (window.__PROMPTS_TXT) await navigator.clipboard.writeText(window.__PROMPTS_TXT);
  };
</script>
</body>
</html>
